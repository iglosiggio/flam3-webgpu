<!DOCTYPE html>
<html>
    <head>
        <title>FLAM3 on WebGPU</title>
        <script type="module" src="main.js">
        </script>
        <meta http-equiv="origin-trial" content="Athxt2w9w8TlIoxz7sUGbJxSP3CxVd1k92JUkY07sUajpbpVhPBjYt/N3lHPr77aRO+LQDCruKyh4hiJ6xYf8woAAABUeyJvcmlnaW4iOiJodHRwczovL2lnbG9zaWdnaW8uZ2l0aHViLmlvOjQ0MyIsImZlYXR1cmUiOiJXZWJHUFUiLCJleHBpcnkiOjE2NTI4MzE5OTl9">
        <style>
            @media (min-width: 1800px) {
                body { columns: 2; }
            }
            xform-editor {
                display: block;
                margin: 1em 1em;
            }
            #xforms {
                display: inline-block;
            }
            #fractal-viewer {
                text-align: center;
            }
            #controls {
                margin-bottom: 0.4em;
            }
        </style>
    </head>
    <body>
        <template id="xform-editor-template">
            <style>
                .vector {
                    vertical-align: middle;
                    display: inline-block;
                    border-color: black;
                    border-style: solid;
                    border-width: 0em 0.01em 0em 0.01em;
                    border-radius: 0.3em;
                }
            </style>
            Variation:
            <select>
                <option>linear</option>
                <option>sinusoidal</option>
                <option>eyefish</option>
            </select>
            <!-- TODO: <button>Remove</button> --><br/>
            <table class="vector">
                <tr>
                    <td><slot name="a">a</slot></td>
                    <td><slot name="b">b</slot></td>
                </tr>
                <tr>
                    <td><slot name="d">d</slot></td>
                    <td><slot name="e">e</slot></td>
                </tr>
            </table>
            x +
            <table class="vector">
                <tr><td><slot name="c">c</slot></td></tr>
                <tr><td><slot name="f">f</slot></td></tr>
            </table></br>
        </template>
        <h1 id="webgpu-not-supported-error" style="display: none;">WebGPU support was not detected</h1>
        <h1 id="webgpu-no-device-error" style="display: none;">No WebGPU device is available</h1>
        <div id="fractal-viewer">
            <div id="controls">
                <button onclick="flam3.start()"          id="flam3-start">Start     </button>
                <button onclick="flam3.stop()"           id="flam3-stop" >Stop      </button>
                <button onclick="flam3.step()"           id="flam3-step" >Step      </button>
                <button onclick="flam3.clear()"          id="flam3-clear">Clear     </button>
                <button onclick="flam3.gui = !flam3.gui" id="flam3-gui"  >Toggle GUI</button>
            </div>
            <canvas id="output" width="900" height="900">
                Sorry, your browser has no canvas support
            </canvas><br/>
        </div>
        <div id="xforms"></div>
        <script type="text/javascript">
            customElements.define('xform-editor', class extends HTMLElement {
                static get observedAttributes() {
                    return ['variation', 'a', 'b', 'c', 'd', 'e', 'f']
                }
                constructor() {
                    super();
                    const template = document.getElementById('xform-editor-template')
                                             .content;
                    this.attachShadow({mode: 'open'})
                        .appendChild(template.cloneNode(true));
                    this.xform = undefined
                    this.shadowRoot.querySelector('select').onchange = ev => this.variation_changed(ev)
                }
                variation_changed(ev) {
                    if (this.xform !== undefined) {
                        this.xform.fn_id = ev.srcElement.value
                        flam3.clear()
                    }
                }
                attributeChangedCallback(name, oldValue, newValue) {
                    if (this.constructor.observedAttributes.includes(name))
                        if (name !== 'variation')
                            this.shadowRoot.querySelector(`slot[name="${name}"]`).textContent = newValue
                        else
                            this.shadowRoot.querySelector('select').value = newValue
                    else
                        console.warn(`Unknown attribute ${name} changed from ${oldValue} to ${newValue}`)
                }
            });

            function add_variation_editor(xform) {
                const elem = document.createElement('xform-editor')
                elem.setAttribute('variation', xform.fn_id)
                elem.setAttribute('a', xform.a)
                elem.setAttribute('b', xform.b)
                elem.setAttribute('c', xform.c)
                elem.setAttribute('d', xform.d)
                elem.setAttribute('e', xform.e)
                elem.setAttribute('f', xform.f)
                elem.xform = xform
                xform.editor = elem
                document.getElementById('xforms').appendChild(elem)
                return elem
            }
        </script>
    </body>
</html>
